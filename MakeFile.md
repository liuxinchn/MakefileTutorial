# MakeFile

------



## 简述

------

Makefile用作自动化编译，它定义了一系列的规则来指定文件编译顺序，以及哪些文件需要重新编译。



## 规则

------

### 普通规则

```makefile
target... : prerequisites ...
     command
```

| 模块          | 描述                                                         |
| ------------- | ------------------------------------------------------------ |
| target        | 可以是一个object file（目标文件），也可以是一个执行文件，还可以是一个标签（label） |
| prerequisites | 生成该target所依赖的文件，可以有多个依赖                     |
| command       | 该target要执行的命令（任意的shell命令）                      |

### 模式规则

“%”可以匹配任何非空字符串。

```makefile
%.o:%.c  
	    gcc -c $< -o $@
```

### 后缀规则

后缀规则不允许依赖文件

```makefile
.c.o: 
	    gcc -c -o $@ $<  
```





## 变量和函数

------

### 等号

| 等号 |                             含义                             |
| :--: | :----------------------------------------------------------: |
|  :=  |                            值传递                            |
|  =   |                            址传递                            |
|  ?=  | 如果左边的变量没有被赋值，那么将等号右边的值赋给左边的变量。否则，保持原来的值不变 |
|  +=  |     将等号右边的值追加到左边变量中，但是中间会有一个空格     |

Makefile中是不允许将变量自己的值赋给自己的：

```makefile
var := ${var} 1 2 3 	# 允许  
var  = ${var} 1 2 3 	# 不允许 
```

### 函数

使用 `$(< function > < arguments >)`的形式可以调用函数。

| 函数名   | 作用                     |
| -------- | ------------------------ |
| wildcard | 扩展通配符，搜索指定文件 |
| patsubst | 字符串替换               |

```makefile
src := $(wildcard ./*.c) #在当前目录下搜索所有的.c文件
objs := $(patsubst %.c, %.o, $(src))  #替换
```

### 自动化变量

| 自动化变量 | 作用                                                         |
| ---------- | ------------------------------------------------------------ |
| $@         | 规则的目标文件名(依赖关系中冒号:左边的文件，如果a: b c，那么$@指a) |
| $<         | 被依赖文件的第一项(如果a: b c，那么$<指b)                    |
| $^         | 所有依赖文件列表，使用空格分隔(如果a: b c ，那么$^指b c)，不包含重复文件 |
| $+         | 所有依赖文件列表，使用空格分隔(如果a: b c c，那么$+指b c c)，包含重复文件 |
| $%         | 当目标文件是一个静态库文件时，代表静态库的一个成员名         |

### 内置变量

| 变量        | 作用                             |
| ----------- | -------------------------------- |
| $(AR)       | *生产 archive 文件的默认程序 ar* |
| $(CC)       | *编译 C 代码的默认编译器 cc*     |
| $(CXX)      | *编译 C++ 代码的默认编译器 g++*  |
| $(CFLAGS)   | *编译 C 代码的参数*              |
| $(CXXFLAGS) | *编译 C++ 代码的参数*            |
| $(LDFLAGS)  | *链接时的参数*                   |
| $(RM)       | rm -rf                           |



## 基本模版

```makefile
CXX = g++
SRCS = $(wildcard *.cpp)
OBJS = $(patsubst %cpp, %o, $(SRCS))
INCLUDE = -I./include   # -I指定头文件目录
LDFLAGS = -L./libs -ltomcrypt  # -L指定库文件目录，-l指定静态库名字(去掉文件名中的lib前缀和.a后缀)
CXXFLAGS = -Wall -O2  # 开启编译warning和设置优化等级

TARGET = TestDemo

.PHONY:all clean

all: $(TARGET)

$(TARGET): $(OBJS)   # 链接时候指定库文件目录及库文件名
	$(CXX) -o $@ $^ $(LDFLAGS)
 
%.o:%.cpp		# 编译时候指定头文件目录
	$(CXX) -c $^ $(INCLUDE) $(CXXFLAGS) -o $@

clean:
	rm -rf $(OBJS) $(TARGET)
```



